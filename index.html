<script>
document.addEventListener('DOMContentLoaded', () => {

    const SUPABASE_URL = 'https://tudwtpbojqvnoueyrvxr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR1ZHd0cGJvanF2bm91ZXlydnhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MjgzOTcsImV4cCI6MjA2NTIwNDM5N30.FYUZ732McidFHjGxGmQSThPhhrQHqI2A1756cRCqpQY';

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const TEAMS = [ { name: '‡∏ó‡∏µ‡∏°‡πÅ‡∏î‡∏á', slug: 'red' }, { name: '‡∏ó‡∏µ‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', slug: 'green' }, { name: '‡∏ó‡∏µ‡∏°‡∏î‡∏≥', slug: 'black' }, { name: '‡∏ó‡∏µ‡∏°‡∏ü‡πâ‡∏≤', slug: 'blue' }, { name: '‡∏ó‡∏µ‡∏°‡∏Ç‡∏≤‡∏ß', slug: 'white' }, { name: '‡∏ó‡∏µ‡∏°‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', slug: 'navy' }, { name: '‡∏ó‡∏µ‡∏°‡∏°‡πà‡∏ß‡∏á', slug: 'purple' }, { name: '‡∏ó‡∏µ‡∏°‡∏ä‡∏°‡∏û‡∏π', slug: 'pink' }, { name: '‡∏ó‡∏µ‡∏°‡∏™‡πâ‡∏°', slug: 'orange' }, { name: '‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', slug: 'yellow' }, ];
    let appData = {};
    let activePage = 'page-schedule';
    let currentDateKey = new Date().toISOString().split('T')[0];
    let isAdmin = false;
    let currentEditingMatchIndex = null;

    const dom = { body: document.body, pages: document.querySelectorAll('.page'), navButtons: document.querySelectorAll('.nav-btn'), content: document.getElementById('content'), adminModal: document.getElementById('admin-login-modal'), adminLoginView: document.getElementById('admin-login-view'), updatePasswordView: document.getElementById('update-password-view'), adminNavBtn: document.getElementById('admin-nav-btn'), editMatchModal: document.getElementById('edit-match-modal'), matchDateInput: document.getElementById('match-date'), generateBtn: document.getElementById('generate-schedule-btn'), };
    
    async function init() {
        setupEventListeners();
        setupPageSetup();

        db.auth.onAuthStateChange(async (event, session) => {
            const newAdminStatus = !!session;
            const statusChanged = isAdmin !== newAdminStatus;
            isAdmin = newAdminStatus;

            if (statusChanged) {
                await updateUIVisibility();
            }

            if (event === 'PASSWORD_RECOVERY') {
                showUpdatePasswordView();
            } else if (event === 'SIGNED_IN') {
                 // After sign-in, ensure data is fresh before rendering
                await loadDataForDate(currentDateKey);
            }
        });
        
        // Initial load starts here
        await updateDateSelectors(); 
        const initialDate = document.getElementById('schedule-date-selector')?.value || currentDateKey;
        await loadDataForDate(initialDate);
        setActivePage(activePage);
        listenToRealtimeChanges();
    }

    function setupEventListeners() {
        dom.navButtons.forEach(btn => btn.addEventListener('click', handleNavClick));
        document.querySelector('#edit-match-modal .close-modal-btn').addEventListener('click', closeEditMatchModal);
        document.getElementById('save-match-changes-btn').addEventListener('click', saveMatchChanges);
        dom.adminModal.querySelector('.close-modal-btn').addEventListener('click', () => dom.adminModal.style.display = 'none');
        document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
        document.getElementById('forgot-password-link').addEventListener('click', handlePasswordResetRequest);
        document.getElementById('update-password-btn').addEventListener('click', handleUpdatePassword);
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) event.target.style.display = 'none'; });
        document.querySelectorAll('.num-stepper-btn').forEach(btn => btn.addEventListener('click', handleNumberStepper));
        document.getElementById('export-schedule-btn').addEventListener('click', (e) => exportElementAsPNG('schedule-container', `TK7-Schedule-${currentDateKey}.png`, e.currentTarget));
        document.getElementById('export-scores-btn').addEventListener('click', (e) => exportElementAsPNG('scores-container', `TK7-Scores-${currentDateKey}.png`, e.currentTarget));
        document.getElementById('export-leaderboard-btn').addEventListener('click', (e) => exportElementAsPNG('page-leaderboard', `TK7-Leaderboard-${currentDateKey}.png`, e.currentTarget));
        dom.matchDateInput.addEventListener('change', (e) => loadDataForDate(e.target.value));
        dom.generateBtn.addEventListener('click', generateAndSaveSchedule);
    }

    function handleNavClick(e) { const button = e.currentTarget; if (button.id === 'admin-nav-btn') { handleAdminNavClick(); } else { setActivePage(button.dataset.page); } }
    
    async function updateUIVisibility() {
        dom.body.classList.toggle('is-admin', isAdmin);
        if (!isAdmin && document.querySelector('.page.active.admin-only')) {
            setActivePage('page-schedule');
        } else {
            // Re-fetch data and render all pages to reflect new permissions.
            await loadDataForDate(currentDateKey);
        }
    }

    function handleAdminNavClick() { if (isAdmin) { if(confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) { handleAdminLogout(); } } else { dom.adminModal.style.display = 'block'; } }
    async function handleAdminLogin() { const email = document.getElementById('admin-email').value; const password = document.getElementById('admin-password').value; const loginBtn = document.getElementById('admin-login-btn'); loginBtn.disabled = true; loginBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...'; const { error } = await db.auth.signInWithPassword({ email, password }); if (error) { alert('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); loginBtn.disabled = false; loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; } else { dom.adminModal.style.display = 'none'; loginBtn.disabled = false; loginBtn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'; } }
    async function handleAdminLogout() { await db.auth.signOut(); }
    async function handlePasswordResetRequest(e) { e.preventDefault(); const email = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà:"); if (!email) return; const { error } = await db.auth.resetPasswordForEmail(email, { redirectTo: window.location.href.split('#')[0] }); if (error) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message); } else { alert("‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Junk/Spam ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö)"); } }
    function showUpdatePasswordView() { dom.adminLoginView.style.display = 'none'; dom.updatePasswordView.style.display = 'block'; dom.adminModal.style.display = 'block'; }
    async function handleUpdatePassword() { const newPassword = document.getElementById('new-password').value; if (newPassword.length < 6) { alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£"); return; } const { data, error } = await db.auth.updateUser({ password: newPassword }); if (error) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: " + error.message); } else { alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"); dom.adminLoginView.style.display = 'block'; dom.updatePasswordView.style.display = 'none'; dom.adminModal.style.display = 'none'; await handleAdminLogout(); } }
    
    function setActivePage(pageId) {
        const pageElement = document.getElementById(pageId);
        if (!pageElement) return;
        if (pageElement.classList.contains('admin-only') && !isAdmin) {
            alert('‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
            dom.adminModal.style.display = 'block';
            return;
        }
        activePage = pageId; 
        dom.pages.forEach(page => page.classList.remove('active'));
        pageElement.classList.add('active');
        dom.navButtons.forEach(btn => {
            btn.classList.toggle('active', btn.dataset.page === pageId && btn.id !== 'admin-nav-btn');
        });
        dom.content.scrollTop = 0;
        renderAllPagesForDate(currentDateKey);
    }

    function renderSchedulePage(date) {
        const container = document.getElementById('schedule-container');
        if(!container) return;
        const dayData = appData[date];
        if (!dayData || !dayData.schedule || dayData.schedule.length === 0) { container.innerHTML = createNoDataMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'üìÖ'); return; }
        const { schedule, settings } = dayData; const startTime = new Date(`${date}T${settings.startTime}`);
        container.innerHTML = schedule.map((match, index) => {
            const matchTime = new Date(startTime.getTime() + index * settings.timePerMatch * 60000);
            const timeStr = matchTime.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            const homeTeam = TEAMS.find(t => t.slug === match.home); const awayTeam = TEAMS.find(t => t.slug === match.away);
            const homeTeamName = homeTeam?.name || 'N/A'; const homeTeamSlug = homeTeam?.slug || 'black';
            const awayTeamName = awayTeam?.name || 'N/A'; const awayTeamSlug = awayTeam?.slug || 'black';
            return `<div class="card match-card"><div class="match-header"><span>‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${index + 1}</span><span>‚è±Ô∏è ${timeStr}</span><button class="edit-match-btn admin-only" data-index="${index}">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div><div class="match-body"><div class="team-emblem ${homeTeamSlug}">${homeTeamName}</div><span class="vs">VS</span><div class="team-emblem ${awayTeamSlug}">${awayTeamName}</div></div></div>`;
        }).join('');
        container.querySelectorAll('.edit-match-btn').forEach(btn => {
             btn.addEventListener('click', (e) => { openEditMatchModal(e.currentTarget.dataset.index); });
        });
    }

    function renderScoresPage(date) {
        const container = document.getElementById('scores-container');
        if(!container) return;
        const dayData = appData[date];
        if (!dayData || !dayData.schedule || dayData.schedule.length === 0) { container.innerHTML = createNoDataMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÑ‡∏î‡πâ', '‚úèÔ∏è'); return; }
        const { schedule } = dayData;
        container.innerHTML = schedule.map((match, index) => {
            const homeTeam = TEAMS.find(t => t.slug === match.home); const awayTeam = TEAMS.find(t => t.slug === match.away);
            const homeTeamName = homeTeam?.name || 'N/A'; const homeTeamSlug = homeTeam?.slug || 'black';
            const awayTeamName = awayTeam?.name || 'N/A'; const awayTeamSlug = awayTeam?.slug || 'black';
            const adminControls = `<div class="score-control admin-only"><button class="score-btn" data-index="${index}" data-team="home" data-op="-1">-</button><input type="number" class="score-input" value="${match.homeScore ?? ''}" data-index="${index}" data-team="home"><button class="score-btn" data-index="${index}" data-team="home" data-op="1">+</button></div>`;
            const userDisplay = `<div class="score-display">${match.homeScore ?? '-'}</div>`;
            const adminControlsAway = `<div class="score-control admin-only"><button class="score-btn" data-index="${index}" data-team="away" data-op="-1">-</button><input type="number" class="score-input" value="${match.awayScore ?? ''}" data-index="${index}" data-team="away"><button class="score-btn" data-index="${index}" data-team="away" data-op="1">+</button></div>`;
            const userDisplayAway = `<div class="score-display">${match.awayScore ?? '-'}</div>`;

            return `<div class="card match-card"><div class="match-header"><span>‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${index + 1}</span><span>${new Date(new Date(`${date}T${dayData.settings.startTime}`).getTime() + index * dayData.settings.timePerMatch * 60000).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit'})}</span></div><div class="match-body"><div class="team-score-wrapper"><div class="team-emblem ${homeTeamSlug}">${homeTeamName}</div>${isAdmin ? adminControls : userDisplay}</div><div class="match-center-controls"><span class="vs">VS</span><button class="reset-score-btn admin-only" data-index="${index}">üîÅ</button></div><div class="team-score-wrapper"><div class="team-emblem ${awayTeamSlug}">${awayTeamName}</div>${isAdmin ? adminControlsAway : userDisplayAway}</div></div></div>`;
        }).join('');
        
        container.querySelectorAll('.score-btn, .score-input, .reset-score-btn').forEach(el => {
            const type = el.tagName === 'INPUT' ? 'input' : 'click';
            const handler = el.classList.contains('score-btn') ? updateScoreFromButton : el.classList.contains('score-input') ? updateScoreFromInput : resetScore;
            el.removeEventListener(type, handler);
            el.addEventListener(type, handler);
        });
    }
    
    async function generateAndSaveSchedule() {
        const date = dom.matchDateInput.value;
        if (!date) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
        const settings = {
            totalHours: parseFloat(document.getElementById('total-hours').value),
            timePerMatch: parseInt(document.getElementById('time-per-match').value),
            startTime: document.getElementById('start-time').value,
            activeTeams: Array.from(document.querySelectorAll('.team-switch:checked')).map(sw => sw.dataset.teamSlug),
            opener: { home: document.getElementById('opener-home').value, away: document.getElementById('opener-away').value },
            closer: { home: document.getElementById('closer-home').value, away: document.getElementById('closer-away').value }
        };
        if (settings.activeTeams.length < 2) return alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ó‡∏µ‡∏°');
        if (settings.opener.home && settings.opener.away && settings.opener.home === settings.opener.away) return alert('‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤-‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô');
        if (settings.closer.home && settings.closer.away && settings.closer.home === settings.closer.away) return alert('‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤-‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô');
        const totalMatches = Math.floor((settings.totalHours * 60) / settings.timePerMatch);
        if (totalMatches <= 0) return alert('‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô');
        
        let teams = [...settings.activeTeams];
        if (teams.length % 2 !== 0) { teams.push(null); }
        let allPossibleMatches = [];
        for (let i = 0; i < teams.length - 1; i++) {
            for (let j = 0; j < teams.length / 2; j++) {
                const home = teams[j];
                const away = teams[teams.length - 1 - j];
                if (home && away) { allPossibleMatches.push({ home, away, homeScore: null, awayScore: null }); }
            }
            teams.splice(1, 0, teams.pop());
        }
        allPossibleMatches.sort(() => Math.random() - 0.5); 
        
        let finalSchedule = allPossibleMatches;
        if (settings.opener.home && settings.opener.away) {
            finalSchedule = finalSchedule.filter(m => !((m.home === settings.opener.home && m.away === settings.opener.away) || (m.home === settings.opener.away && m.away === settings.opener.home)));
            finalSchedule.unshift({ home: settings.opener.home, away: settings.opener.away, homeScore: null, awayScore: null });
        }
        
        let closerMatch = null;
        if (settings.closer.home && settings.closer.away) {
            closerMatch = { home: settings.closer.home, away: settings.closer.away, homeScore: null, awayScore: null };
            finalSchedule = finalSchedule.filter(m => !((m.home === settings.closer.home && m.away === settings.closer.away) || (m.home === settings.closer.away && m.away === settings.closer.home)));
        }
        
        const sizeLimit = closerMatch ? totalMatches - 1 : totalMatches;
        finalSchedule = finalSchedule.slice(0, sizeLimit);
        
        if (closerMatch) { finalSchedule.push(closerMatch); }

        const { error } = await db.from('match_days').upsert({ match_date: date, settings: settings, schedule: finalSchedule }, { onConflict: 'match_date' });
        if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message); } 
        else { alert('‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!'); await loadDataForDate(date); setActivePage('page-schedule'); }
    }
    
    async function deleteDay() { const dateToDelete = document.getElementById('schedule-date-selector')?.value; if (dateToDelete && confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateToDelete} ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?`)) { const { error } = await db.from('match_days').delete().eq('match_date', dateToDelete); if (error) alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message); else alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'); } }
    function renderAllPagesForDate(date) { if (!date || !appData) return; renderSchedulePage(date); renderScoresPage(date); renderLeaderboardPage(date); }
    async function updateDateSelectors() { const { data: datesData } = await db.from('match_days').select('match_date').order('match_date', { ascending: false }); const dates = datesData?.map(d => d.match_date) || []; const selectors = [document.getElementById('schedule-date-selector'), document.getElementById('scores-date-selector')]; selectors.forEach(selector => { if (!selector) return; const currentVal = selector.value; selector.innerHTML = ''; if (dates.length === 0) { selector.innerHTML = '<option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>'; currentDateKey = new Date().toISOString().split('T')[0]; } else { dates.forEach(date => { const option = document.createElement('option'); option.value = date; option.textContent = new Date(date + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); selector.appendChild(option); }); } if (dates.includes(currentVal)) { selector.value = currentVal; } else { selector.value = currentDateKey = dates[0] || new Date().toISOString().split('T')[0]; } }); document.querySelectorAll('.date-selector-container select').forEach(s => { if(s) s.onchange = (e) => { const newDate = e.target.value; loadDataForDate(newDate); selectors.forEach(sel => { if(sel) sel.value = newDate; }); }; }); const delBtn = document.getElementById('delete-day-btn'); if(delBtn) delBtn.onclick = deleteDay; }
    function createNoDataMessage(message, icon) { return `<div id="no-data-message"><div class="icon">${icon}</div><p>${message}</p></div>`; }
    function renderLeaderboardPage(date) { const container = document.getElementById('leaderboard-container'); if(!container) return; const dayData = appData[date]; let selectorHTML = '<div class="date-selector-container"><select id="leaderboard-date-selector-inner"></select></div>'; if (!dayData || !dayData.settings || !dayData.settings.activeTeams) { container.innerHTML = selectorHTML + createNoDataMessage('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', 'üìä'); updateLeaderboardDateSelector(); return; } const stats = calculateLeaderboard(date); const sortedTeams = Object.values(stats).sort((a, b) => { if (b.pts !== a.pts) return b.pts - a.pts; if (b.gd !== a.gd) return b.gd - a.gd; if (b.gf !== a.gf) return b.gf - a.gf; return a.name.localeCompare(b.name); }); const medals = ['ü•á', 'ü•à', 'ü•â']; const tableHTML = `<table class="leaderboard-table"><thead><tr><th>#</th><th class="team-name">‡∏ó‡∏µ‡∏°</th><th>‡πÅ‡∏Ç‡πà‡∏á</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÄ‡∏™‡∏°‡∏≠</th><th>‡πÅ‡∏û‡πâ</th><th>‡πÑ‡∏î‡πâ</th><th>‡πÄ‡∏™‡∏µ‡∏¢</th><th>+/-</th><th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th></tr></thead><tbody>${sortedTeams.map((team, index) => `<tr><td>${medals[index] || index + 1}</td><td class="team-name"><div class="team-emblem ${TEAMS.find(t=>t.name===team.name)?.slug}" style="display:inline-flex; padding: 4px 8px; font-size: 14px;">${team.name}</div></td><td>${team.p}</td><td>${team.w}</td><td>${team.d}</td><td>${team.l}</td><td>${team.gf}</td><td>${team.ga}</td><td>${team.gd}</td><td><strong>${team.pts}</strong></td></tr>`).join('')}</tbody></table>`; container.innerHTML = selectorHTML + tableHTML; updateLeaderboardDateSelector(); }
    async function updateLeaderboardDateSelector() { const { data: datesData } = await db.from('match_days').select('match_date').order('match_date', { ascending: false }); const selector = document.getElementById('leaderboard-date-selector-inner'); if(!selector) return; const dates = datesData ? datesData.map(d => d.match_date) : []; selector.innerHTML = ''; if (dates.length === 0) { selector.innerHTML = '<option>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</option>'; } else { dates.forEach(date => { const option = document.createElement('option'); option.value = date; option.textContent = new Date(date + 'T00:00:00').toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }); selector.appendChild(option); }); } selector.value = currentDateKey; selector.onchange = (e) => { const newDate = e.target.value; loadDataForDate(newDate); document.getElementById('schedule-date-selector').value = newDate; document.getElementById('scores-date-selector').value = newDate; }; }
    async function updateScore(index, team, value) { if(!isAdmin) return; const date = currentDateKey; let dayData = appData[date]; if (!dayData) return; const newSchedule = [...dayData.schedule]; newSchedule[index][team === 'home' ? 'homeScore' : 'awayScore'] = value; const { error } = await db.from('match_days').update({ schedule: newSchedule }).eq('match_date', date); if (error) alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ' + error.message); }
    function updateScoreFromButton(event) { const { index, team, op } = event.currentTarget.dataset; const input = document.querySelector(`.score-input[data-index="${index}"][data-team="${team}"]`); let currentValue = input.value === '' ? -1 : parseInt(input.value); currentValue = (op === '1') ? currentValue + 1 : Math.max(0, currentValue - 1); input.value = currentValue; updateScore(index, team, currentValue); }
    function updateScoreFromInput(event) { const { index, team } = event.currentTarget.dataset; let value = event.currentTarget.value === '' ? null : Math.max(0, parseInt(event.currentTarget.value)); event.currentTarget.value = value === null ? '' : value; updateScore(index, team, value); }
    function resetScore(event) { const { index } = event.currentTarget.dataset; updateScore(index, 'home', null); updateScore(index, 'away', null); }
    function calculateLeaderboard(date) { const dayData = appData[date]; const stats = {}; if(!dayData || !dayData.settings || !dayData.settings.activeTeams) return {}; dayData.settings.activeTeams.forEach(slug => { const teamInfo = TEAMS.find(t => t.slug === slug); if(teamInfo) stats[slug] = { name: teamInfo.name, p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, gd: 0, pts: 0 }; }); dayData.schedule.forEach(match => { if (match.homeScore === null || match.awayScore === null || !stats[match.home] || !stats[match.away]) return; stats[match.home].p++; stats[match.away].p++; stats[match.home].gf += match.homeScore; stats[match.home].ga += match.awayScore; stats[match.away].gf += match.awayScore; stats[match.away].ga += match.homeScore; if (match.homeScore > match.awayScore) { stats[match.home].w++; stats[match.away].l++; stats[match.home].pts += 3; } else if (match.awayScore > match.homeScore) { stats[match.away].w++; stats[match.home].l++; stats[match.away].pts += 3; } else { stats[match.home].d++; stats[match.away].d++; stats[match.home].pts += 1; stats[match.away].pts += 1; } }); Object.values(stats).forEach(team => { team.gd = team.gf - team.ga; }); return stats; }
    function openEditMatchModal(index) { currentEditingMatchIndex = parseInt(index); const date = currentDateKey; const dayData = appData[date]; if (!dayData) return; const match = dayData.schedule[currentEditingMatchIndex]; const activeTeams = dayData.settings.activeTeams; const homeSelect = document.getElementById('modal-home-team'); const awaySelect = document.getElementById('modal-away-team'); homeSelect.innerHTML = ''; awaySelect.innerHTML = ''; activeTeams.forEach(teamSlug => { const team = TEAMS.find(t => t.slug === teamSlug); if(team) { const option = `<option value="${team.slug}">${team.name}</option>`; homeSelect.innerHTML += option; awaySelect.innerHTML += option; } }); homeSelect.value = match.home; awaySelect.value = match.away; document.getElementById('modal-match-info').textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà ${currentEditingMatchIndex + 1}`; dom.editMatchModal.style.display = 'block'; }
    function closeEditMatchModal() { dom.editMatchModal.style.display = 'none'; currentEditingMatchIndex = null; }
    async function saveMatchChanges() { if (currentEditingMatchIndex === null) return; const date = currentDateKey; const dayData = appData[date]; const newHomeSlug = document.getElementById('modal-home-team').value; const newAwaySlug = document.getElementById('modal-away-team').value; if (newHomeSlug === newAwaySlug) { alert('‡∏ó‡∏µ‡∏°‡πÄ‡∏´‡∏¢‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡∏°‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô!'); return; } const newSchedule = [...dayData.schedule]; newSchedule[currentEditingMatchIndex].home = newHomeSlug; newSchedule[currentEditingMatchIndex].away = newAwaySlug; const { error } = await db.from('match_days').update({ schedule: newSchedule }).eq('match_date', date); if (error) { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + error.message); } else { alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!'); closeEditMatchModal(); } }
    function exportElementAsPNG(elementId, filename, buttonElement) { const elementToCapture = document.getElementById(elementId); const mainContent = dom.content; if (!elementToCapture) return; const originalText = buttonElement.innerHTML; buttonElement.innerHTML = '‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...'; buttonElement.disabled = true; const originalOverflow = mainContent.style.overflowY; const originalHeight = mainContent.style.height; mainContent.style.overflowY = 'visible'; mainContent.style.height = 'auto'; html2canvas(elementToCapture, { backgroundColor: '#121212', useCORS: true, scale: 2 }).then(canvas => { const link = document.createElement('a'); link.download = filename; link.href = canvas.toDataURL('image/png'); link.click(); }).catch(() => { alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'); }).finally(() => { mainContent.style.overflowY = originalOverflow; mainContent.style.height = originalHeight; buttonElement.innerHTML = originalText; buttonElement.disabled = false; }); }
    function setupPageSetup() { const selects = [document.getElementById('opener-home'), document.getElementById('opener-away'), document.getElementById('closer-home'), document.getElementById('closer-away')]; selects.forEach(s => s.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>'); document.getElementById('team-toggle-container').innerHTML = ''; TEAMS.forEach(team => { const option = `<option value="${team.slug}">${team.name}</option>`; selects.forEach(s => s.innerHTML += option); const toggleHtml = `<div class="team-toggle"><div class="team-emblem ${team.slug}">${team.name}</div><label class="switch"><input type="checkbox" class="team-switch" data-team-slug="${team.slug}" checked><span class="slider"></span></label></div>`; document.getElementById('team-toggle-container').innerHTML += toggleHtml; }); }
    async function loadDataForDate(date) { currentDateKey = date; if(dom.matchDateInput) dom.matchDateInput.value = date; const { data } = await db.from('match_days').select('*').eq('match_date', date).single(); appData[date] = data; if (data) { loadSettingsFromData(data.settings); } else { resetSettingsForm(); } renderAllPagesForDate(date); }

    init();
});
</script>
</body>
</html>
